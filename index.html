<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é«˜é›„åšå£«ç­ï½œèª²ç¨‹å ±åç³»çµ±ï½œå³æ™‚åå–®</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .dropdown-menu-scroll { max-height: 320px; overflow-y: auto; }
    .cursor-pointer { cursor: pointer; }
    .shadow-soft { box-shadow: 0 0.5rem 1rem rgba(0,0,0,.08); }
    #qrContainer {
      width: 240px; height: 240px;
      display: flex; align-items: center; justify-content: center;
      background: #fff; border: 1px solid rgba(0,0,0,.1); border-radius: .5rem;
    }
    /* è¡¨æ ¼ï¼šä¾å…§å®¹å¯¬åº¦ï¼›æ‰‹æ©Ÿå¯æ©«å‘æ²å‹• */
    .table-wrap{ width:100%; }
    @media (max-width:768px){
      .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
      #rosterTable{ min-width: 680px; }
    }
    #rosterTable{ table-layout:auto; white-space:nowrap; }
    /* Toggle */
    .switch{
      display:inline-block; position:relative; width:42px; height:24px;
      background:#e5e7eb; border-radius:999px; border:1px solid #dee2e6; vertical-align:middle;
    }
    .switch::after{
      content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:50%;
      background:#fff; transition:all .2s ease; box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    .switch.on{ background:#c6f6d5; border-color:#8ce99a; }
    .switch.on::after{ transform:translateX(18px); }
    .edit-toolbar .btn + .btn { margin-left:.5rem; }
    .form-control-note{ padding: .375rem .5rem; font-size:.9rem; }
    /* ç¢ºèªè¦–çª—è¡¨æ ¼ */
    #confirmSubmitModal .oldnew small{ color:#6c757d; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="#">é«˜é›„åšå£«ç­ï½œèª²ç¨‹å ±ååå–®</a>
    </div>
  </nav>

  <main class="container py-4">
    <!-- æœå°‹åˆ— -->
    <div class="card shadow-soft mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-lg-8">
            <div class="input-group">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="allCoursesBtn">æ‰€æœ‰èª²ç¨‹</button>
              <ul class="dropdown-menu dropdown-menu-scroll" id="allCoursesMenu" aria-labelledby="allCoursesBtn">
                <li class="px-3 py-2 text-secondary">è¼‰å…¥ä¸­â€¦</li>
              </ul>
              <input id="searchInput" type="text" class="form-control" placeholder="è¼¸å…¥æ—¥æœŸï¼ˆå¦‚ 20250822ï¼‰ã€èª²ç¨‹åç¨±ï¼Œæˆ–è¼¸å…¥ all / å…¨éƒ¨ é¡¯ç¤ºå…¨éƒ¨â€¦" aria-label="æœå°‹èª²ç¨‹" />
              <button id="searchBtn" class="btn btn-primary" type="button">æœå°‹</button>
            </div>
          </div>
          <div class="col-12 col-lg-4 text-lg-end">
            <small class="text-secondary" id="statusText">â€”</small>
          </div>
        </div>
      </div>
    </div>

    <!-- æœå°‹çµæœ -->
    <div id="searchResultsWrap" class="mb-3 d-none">
      <div class="d-flex align-items-center justify-content-between">
        <h6 class="text-secondary mb-2">æœå°‹çµæœ</h6>
        <button id="clearSearchBtn" class="btn btn-link btn-sm p-0">æ¸…é™¤</button>
      </div>
      <div class="row g-2" id="searchResults"></div>
    </div>

    <!-- æœ€è¿‘å››å€‹èª²ç¨‹ -->
    <div class="mb-3">
      <h6 class="text-secondary mb-2">æœ€è¿‘å››å€‹èª²ç¨‹</h6>
      <div class="row g-2" id="upcomingFour"></div>
    </div>

    <!-- æ¨™é¡Œ + è¨ˆæ•¸ + å·¥å…·åˆ— -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="d-flex align-items-center gap-2">
        <h5 class="m-0" id="courseTitle">è«‹å¾ä¸Šæ–¹é¸æ“‡èª²ç¨‹</h5>
        <div id="courseCounters" class="d-none">
          <span class="badge text-bg-primary" id="countTotal">å ±å 0</span>
          <span class="badge text-bg-success ms-1" id="countPaid">å·²ç¹³ 0</span>
        </div>
      </div>
      <div class="edit-toolbar">
        <button id="editToggleBtn" class="btn btn-outline-primary btn-sm" disabled>ä¿®æ”¹è³‡æ–™</button>
        <button id="saveChangesBtn" class="btn btn-primary btn-sm d-none">é€å‡ºä¿®æ”¹</button>
        <button id="refreshBtn" class="btn btn-outline-secondary btn-sm" disabled>é‡æ–°æ•´ç†</button>
      </div>
    </div>

    <!-- è³‡æ–™è¡¨ -->
    <div class="card shadow-soft mb-3">
      <div class="card-body">
        <div class="table-wrap">
          <table class="table table-striped align-middle" id="rosterTable">
            <thead>
              <tr id="rosterHeadRow">
                <th>åºè™Ÿ</th>
                <th>å§“å</th>
                <th>é‚€è«‹äºº</th>
                <th>ç¹³è²»ç‹€æ…‹</th>
                <th>ç°½åˆ°</th>
                <th>è¨»è¨˜</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-secondary">å°šæœªé¸å–èª²ç¨‹</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- å¿«é€Ÿè¤‡è£½æ–‡å­— -->
    <div class="card shadow-soft mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="m-0 text-secondary">å¿«é€Ÿè¤‡è£½æ–‡å­—</h6>
          <button id="copyBtn" class="btn btn-outline-primary btn-sm">è¤‡è£½</button>
        </div>
        <textarea id="shareText" class="form-control" rows="12" readonly placeholder="é¸å–èª²ç¨‹å¾Œï¼Œé€™è£¡æœƒè‡ªå‹•ç”¢ç”Ÿå¯è¤‡è£½çš„æ–‡å­—å…§å®¹"></textarea>
      </div>
    </div>

    <!-- å ±åé€£çµ + QRCode -->
    <div class="card shadow-soft">
      <div class="card-body">
        <div class="mb-2">
          <label class="form-label small text-secondary">å®Œæ•´ç¶²å€ï¼ˆLINE é–‹å•Ÿè¨Šæ¯ï¼‰</label>
          <div class="input-group">
            <input id="fullUrlInput" type="text" class="form-control" readonly placeholder="é¸æ“‡èª²ç¨‹å¾Œè‡ªå‹•ç”¢ç”Ÿ">
            <button id="copyFullUrlBtn" class="btn btn-outline-primary" type="button" disabled>è¤‡è£½</button>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label small text-secondary">çŸ­ç¶²å€</label>
          <div class="input-group">
            <input id="shortUrlInput" type="text" class="form-control" readonly placeholder="é¸æ“‡èª²ç¨‹å¾Œè‡ªå‹•ç”¢ç”Ÿï¼ˆis.gdï¼‰">
            <button id="copyShortUrlBtn" class="btn btn-outline-primary" type="button" disabled>è¤‡è£½</button>
          </div>
          <div class="form-text">è‹¥ç„¡æ³•ç”¢ç”Ÿï¼Œè«‹æ”¹ç”¨å®Œæ•´ç¶²å€æˆ–ç¨å¾Œå†è©¦ã€‚</div>
        </div>

        <div class="d-flex align-items-start gap-3 flex-wrap">
          <div>
            <div id="qrContainer"><span class="text-secondary small">è«‹å…ˆé¸æ“‡èª²ç¨‹</span></div>
            <div class="small text-secondary mt-2" id="qrCaption">å°‡ç”¢ç”Ÿï¼šLINE å‚³é€ã€Œå ±å YYYYMMDD{èª²ç¨‹åç¨±}ã€</div>
          </div>
          <div class="d-flex flex-column gap-2">
            <button id="copyQrBtn" class="btn btn-outline-primary btn-sm" disabled>è¤‡è£½åœ–ç‰‡</button>
            <button id="downloadQrBtn" class="btn btn-outline-secondary btn-sm" disabled>ä¸‹è¼‰åœ–ç‰‡</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">æç¤º</strong>
        <small class="text-muted">ç¾åœ¨</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody">â€”</div>
    </div>
  </div>

  <!-- å¯†ç¢¼è¼¸å…¥ Modal -->
  <div class="modal fade" id="editPwdModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-soft">
        <div class="modal-header">
          <h5 class="modal-title">è¼¸å…¥å¯†ç¢¼</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          <label for="editPwdInput" class="form-label">è«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥ä¿®æ”¹æ¨¡å¼</label>
          <div class="input-group">
            <input type="password" id="editPwdInput" class="form-control" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
            <button class="btn btn-outline-secondary" type="button" id="togglePwdBtn">é¡¯ç¤º</button>
          </div>
          <div id="editPwdError" class="form-text text-danger d-none mt-1">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="editPwdConfirmBtn">ç¢ºèª</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€å‡ºä¿®æ”¹å‰çš„ç¢ºèª Modalï¼ˆè¡¨æ ¼ï¼‰ -->
  <div class="modal fade" id="confirmSubmitModal" tabindex="-1" aria-hidden="true" aria-labelledby="confirmSubmitLabel">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content shadow-soft">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmSubmitLabel">ç¢ºèªé€å‡ºä¿®æ”¹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3 text-secondary" id="confirmSummary">ä»¥ä¸‹ç‚ºæœ¬æ¬¡ä¿®æ”¹é …ç›®ï¼š</p>
          <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0" id="confirmTable">
              <thead>
                <tr id="confirmTableHead">
                  <!-- ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
                </tr>
              </thead>
              <tbody id="confirmTableBody">
                <!-- ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">è¿”å›ä¿®æ”¹</button>
          <button class="btn btn-primary" id="confirmSubmitBtn">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="confirmSpinner"></span>
            ç¢ºèªé€å‡º
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¾åºè¼‰å…¥ï¼šQRCode â†’ Bootstrapï¼ˆä¾›ä¸‹æ–¹ç¨‹å¼ç”¨ï¼‰â†’ è‡ªè¨‚è…³æœ¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // === å¯èª¿åƒæ•¸ ===
    const SPREADSHEET_ID = "1dHKNksMN3jiB7EVCtgJLdCY3ggy2jokCMfNLCXmGNf4";
    const API_KEY = "AIzaSyDy5xNMYYqI_aBSMNHbp5tNcPCl84NS2Nc";
    const SUBMIT_URL = "https://tzhengliin.synology.me/bossclass/verify/bulk_update";

    // === DOM ===
    const allCoursesMenu = document.getElementById("allCoursesMenu");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const statusText = document.getElementById("statusText");
    const upcomingFour = document.getElementById("upcomingFour");
    const rosterTable = document.getElementById("rosterTable");
    const rosterHeadRow = document.getElementById("rosterHeadRow");
    const rosterTableBody = rosterTable.querySelector("tbody");
    const courseTitle = document.getElementById("courseTitle");
    const refreshBtn = document.getElementById("refreshBtn");
    const editToggleBtn = document.getElementById("editToggleBtn");
    const saveChangesBtn = document.getElementById("saveChangesBtn");
    const searchResultsWrap = document.getElementById("searchResultsWrap");
    const searchResults = document.getElementById("searchResults");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const courseCounters = document.getElementById("courseCounters");
    const countTotalEl = document.getElementById("countTotal");
    const countPaidEl = document.getElementById("countPaid");

    const shareTextEl = document.getElementById("shareText");
    const copyBtn = document.getElementById("copyBtn");

    const fullUrlInput = document.getElementById("fullUrlInput");
    const copyFullUrlBtn = document.getElementById("copyFullUrlBtn");
    const shortUrlInput = document.getElementById("shortUrlInput");
    const copyShortUrlBtn = document.getElementById("copyShortUrlBtn");

    const copyQrBtn = document.getElementById("copyQrBtn");
    const downloadQrBtn = document.getElementById("downloadQrBtn");

    // === å¯†ç¢¼ Modal DOM ===
    const editPwdModalEl    = document.getElementById('editPwdModal');
    const editPwdInput      = document.getElementById('editPwdInput');
    const editPwdError      = document.getElementById('editPwdError');
    const editPwdConfirmBtn = document.getElementById('editPwdConfirmBtn');
    const togglePwdBtn      = document.getElementById('togglePwdBtn');
    let editPwdModal; // Bootstrap.Modal å¯¦ä¾‹

    // === ç¢ºèªé€å‡º Modal DOM ===
    const confirmModalEl     = document.getElementById('confirmSubmitModal');
    const confirmTableHead   = document.getElementById('confirmTableHead');
    const confirmTableBody   = document.getElementById('confirmTableBody');
    const confirmSubmitBtn   = document.getElementById('confirmSubmitBtn');
    const confirmSpinner     = document.getElementById('confirmSpinner');
    const confirmSummary     = document.getElementById('confirmSummary');
    let confirmModal; // Bootstrap.Modal å¯¦ä¾‹
    let pendingChanges = null; // æš«å­˜æ¬²é€å‡ºçš„ payload

    // === ç‹€æ…‹ ===
    let courses = [];           // { title, dateStr, date, sheetId }
    let futureCourses = [];
    let selectedCourse = null;
    let editMode = false;
    let currentFullUrl = '';
    let currentShortUrl = '';
    let showMeal = false;       // æ˜¯å¦é¡¯ç¤ºã€Œé¤é£Ÿè²»ã€æ¬„ä½

    // å·¥å…·
    function showToast(msg){
      document.getElementById("toastBody").textContent = msg;
      new bootstrap.Toast(document.getElementById("toast")).show();
    }
    function yyyymmddToDate(str){ return new Date(+str.slice(0,4), +str.slice(4,6)-1, +str.slice(6,8)); }
    function formatDate(d){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0'); return `${y}/${m}/${da}`; }
    function formatDateCompact(d){ return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; }
    function isCourseSheet(title){ return /^\d{8}/.test(title); }
    function extractDateStr(title){ return title.slice(0,8); }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function getCourseDisplayName(course){ const raw = course?.title || ""; const noDate = raw.replace(/^\d{8}/,"").trim(); return noDate || raw; }
    function explainFetchError(status, text){
      if (status === 403) {
        if (/The caller does not have permission|Permission denied|insufficient permissions/i.test(text)) return "æ¬Šé™ä¸è¶³ï¼šè«‹æŠŠè©¦ç®—è¡¨å…±ç”¨è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äºº â†’ æª¢è¦–è€…ã€ã€‚";
        if (/Referer.*not.*allowed|API keys with referer restrictions cannot be used/i.test(text)) return "API Key ä¾†æºé™åˆ¶ï¼šè«‹åœ¨ API Key é™åˆ¶åŠ å…¥ç›®å‰ç¶²åŸŸã€‚";
      }
      if (status === 400 && /API key not valid/i.test(text)) return "API Key ç„¡æ•ˆæˆ–æœªå•Ÿç”¨ Sheets APIã€‚";
      return `è®€å–å¤±æ•—ï¼ˆ${status}ï¼‰ï¼š${text.slice(0,180)}...`;
    }
    function isPaidValue(val){
      const s = String(val||"").replace(/\s+/g,"").toLowerCase();
      if (!s) return false;
      if (["y","yes","true","1","paid"].includes(s)) return true;
      if (s.includes("å·²ç¹³")||s.includes("å·²ä»˜æ¬¾")||s.includes("å·²ä»˜")||s.includes("ç¹³æ¸…")||s.includes("ä»˜æ¬¾å®Œæˆ")||s==="æ˜¯"||s==="æœ‰") return true;
      return false;
    }
    function normalizeMeal(val){
      const s = String(val||"").trim().toLowerCase().replace(/\s+/g,"");
      if (!s) return "";
      if (["y","yes","true","1","paid"].includes(s)) return "å·²ç¹³";
      if (s.includes("å·²ç¹³")||s.includes("ç¹³æ¸…")||s.includes("å·²ä»˜")||s.includes("ä»˜æ¬¾å®Œæˆ")) return "å·²ç¹³";
      return "";
    }
    function paymentIcon(v){
      const s = String(v||"").trim().toLowerCase().replace(/\s+/g,"");
      if (s.includes("é•·å®¢")||s.includes("é•·å®¢åˆ¸")) return "ğŸ”–";
      if (s.includes("linepay")||s.includes("line-pay")||s.includes("lineæ”¯ä»˜")||s.includes("â“")) return "â“";
      if (s.includes("ç¾é‡‘")||s.includes("å·²ç¹³")||s.includes("å·²ä»˜")||s.includes("å·²ä»˜æ¬¾")||s.includes("ç¹³æ¸…")||s.includes("ä»˜æ¬¾å®Œæˆ")||["paid","cash","y","yes","1","true"].includes(s)) return "ğŸ’°";
      return "";
    }
    function checkinIcon(v){
      const s = String(v||"").trim().toLowerCase();
      if (s.includes("å·²å ±åˆ°")||s.includes("å·²ç°½åˆ°")||["æ˜¯","y","yes","1","true","v","âœ“","âˆš"].includes(s)) return "âœ…";
      return "";
    }

    // Sheets API
    async function fetchSheetsList(){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets(properties(sheetId%2Ctitle))&key=${API_KEY}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(explainFetchError(res.status, await res.text()));
      return res.json();
    }
    async function fetchSheetValuesByTitle(title){
      const range = `${encodeURIComponent(title)}!A1:Z2000`;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?majorDimension=ROWS&key=${API_KEY}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(explainFetchError(res.status, await res.text()));
      return res.json();
    }

    // æ¸²æŸ“è¡¨é ­ï¼ˆä¾ showMealï¼‰
    function renderHeader(){
      rosterHeadRow.innerHTML = showMeal
        ? `<th>åºè™Ÿ</th><th>å§“å</th><th>é‚€è«‹äºº</th><th>ç¹³è²»ç‹€æ…‹</th><th>é¤é£Ÿè²»</th><th>ç°½åˆ°</th><th>è¨»è¨˜</th>`
        : `<th>åºè™Ÿ</th><th>å§“å</th><th>é‚€è«‹äºº</th><th>ç¹³è²»ç‹€æ…‹</th><th>ç°½åˆ°</th><th>è¨»è¨˜</th>`;
    }

    // æ¸²æŸ“åå–®ï¼ˆä¾ editMode / showMealï¼‰
    function renderRoster(rows){
      renderHeader();
      rosterTableBody.innerHTML = "";
      if (!rows.length){
        rosterTableBody.innerHTML = `<tr><td colspan="${showMeal?7:6}" class="text-secondary">å°šç„¡è³‡æ–™</td></tr>`;
        return;
      }

      rows.forEach((r, i)=>{
        const tr = document.createElement('tr');
        tr.dataset.row = String(r.row_index);
        tr.dataset.name = r.å§“å || '';

        if (!editMode){
          const cells = [
            `<td class="text-secondary">${i+1}</td>`,
            `<td>${escapeHtml(r.å§“å??"")}</td>`,
            `<td>${escapeHtml(r.é‚€è«‹äºº??"")}</td>`,
            `<td>${escapeHtml(r.ç¹³è²»ç‹€æ…‹??"")}</td>`
          ];
          if (showMeal) cells.push(`<td>${escapeHtml(r.é¤é£Ÿè²»??"")}</td>`);
          cells.push(
            `<td>${escapeHtml(r.ç°½åˆ°??"")}</td>`,
            `<td>${escapeHtml(r.è¨»è¨˜??"")}</td>`
          );
          tr.innerHTML = cells.join('');
        } else {
          tr.classList.add('edit-row');
          tr.dataset.paid = r.ç¹³è²»ç‹€æ…‹ || '';
          tr.dataset.checkin = r.ç°½åˆ° || '';
          tr.dataset.note = r.è¨»è¨˜ || '';
          if (showMeal) tr.dataset.meal = r.é¤é£Ÿè²» || '';

          const cells = [
            `<td class="text-secondary">${i+1}</td>`,
            `<td class="fw-semibold">${escapeHtml(r.å§“å??"")}</td>`,
            `<td>${escapeHtml(r.é‚€è«‹äºº??"")}</td>`,
            `<td data-field="paid">
              <select class="form-select form-select-sm" style="width:auto;">
                ${["","ç¾é‡‘","Linepay","é•·å®¢åˆ¸","ç„¡é ˆç¹³è²»"].map(opt=>{
                  const short = opt===""?"æœªç¹³":(opt==="Linepay"?"Line":(opt==="é•·å®¢åˆ¸"?"é•·å®¢":(opt==="ç„¡é ˆç¹³è²»"?"å…ç¹³":opt)));
                  const sel = (opt === (r.ç¹³è²»ç‹€æ…‹||"")) ? "selected" : "";
                  return `<option value="${opt}" ${sel}>${short}</option>`;
                }).join("")}
              </select>
            </td>`
          ];

          if (showMeal){
            cells.push(
              `<td data-field="meal">
                 <div class="switch ${r.é¤é£Ÿè²»==="å·²ç¹³"?"on":""}" role="switch" tabindex="0" aria-checked="${r.é¤é£Ÿè²»==="å·²ç¹³"}"></div>
               </td>`
            );
          }

          cells.push(
            `<td data-field="checkin">
               <div class="switch ${r.ç°½åˆ°==="å·²å ±åˆ°"?"on":""}" role="switch" tabindex="0" aria-checked="${r.ç°½åˆ°==="å·²å ±åˆ°"}"></div>
             </td>`,
            `<td data-field="note">
               <input class="form-control form-control-note" type="text" value="${escapeHtml(r.è¨»è¨˜||"")}" placeholder="å¯è¼¸å…¥è¨»è¨˜">
             </td>`
          );

          tr.innerHTML = cells.join('');
        }

        rosterTableBody.appendChild(tr);
      });
    }

    function updateCounters(total, paid){
      countTotalEl.textContent = `å ±å ${total}`;
      countPaidEl.textContent = `å·²ç¹³ ${paid}`;
      courseCounters.classList.remove("d-none");
      editToggleBtn.disabled = !selectedCourse;
    }

    // åˆ†äº«æ–‡å­—
    function buildShareText(course, rows, shortUrl){
      if (!course) return "";
      const dateStr = formatDate(course.date);
      const courseName = getCourseDisplayName(course);
      const header = [`èª²ç¨‹æ—¥æœŸï¼š${dateStr}`, `èª²ç¨‹åç¨±ï¼š${courseName}`];
      if (shortUrl && /^https?:\/\//i.test(shortUrl)) header.push(`å ±åç¶²å€ï¼š${shortUrl}`);
      header.push(`ğŸ’°ï¼šç¾é‡‘/å·²ç¹³è²»     â“ï¼šLinepay`, `ğŸ”–ï¼šé•·å®¢åˆ¸            âœ…ï¼šå®Œæˆå ±åˆ°`, `--------------`, `äººå“¡æ¸…å–®ï¼š`);
      const body = rows.map((r,i)=>{
        const name = r.å§“å || "", inviter = r.é‚€è«‹äºº || "";
        const payIcon = paymentIcon(r.ç¹³è²»ç‹€æ…‹), checkIcon = checkinIcon(r.ç°½åˆ°);
        const inviterText = inviter ? `(${inviter})` : "";
        return `${i+1}.${name}${inviterText}${payIcon}${checkIcon}`;
      });
      return [...header, ...body].join("\n");
    }
    function fillShareText(course, rows, shortUrl){ shareTextEl.value = buildShareText(course, rows, shortUrl); }

    // LINE URL èˆ‡ QR
    function buildLineUrl(course){
      if (!course) return "";
      const ymd = formatDateCompact(course.date);
      const cName = getCourseDisplayName(course);
      const msg = `å ±å ${ymd}${cName}`;
      return `https://line.me/R/oaMessage/%40667xkonq/?${encodeURIComponent(msg)}`;
    }
    function getQrCanvas(){
      const box = document.getElementById('qrContainer');
      let cv = box.querySelector('canvas'); if (cv) return cv;
      const img = box.querySelector('img'); if (!img) return null;
      cv = document.createElement('canvas');
      const w = img.naturalWidth || 240, h = img.naturalHeight || 240;
      cv.width = w; cv.height = h;
      const ctx = cv.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h); return cv;
    }
    function updateQRCodeWithUrl(url, course){
      const box = document.getElementById('qrContainer');
      const caption = document.getElementById('qrCaption');
      if (!url || !course){
        box.innerHTML = '<span class="text-secondary small">è«‹å…ˆé¸æ“‡èª²ç¨‹</span>';
        caption.textContent = 'å°‡ç”¢ç”Ÿï¼šLINE å‚³é€ã€Œå ±å YYYYMMDD{èª²ç¨‹åç¨±}ã€';
        copyQrBtn.disabled = true; downloadQrBtn.disabled = true; return;
      }
      const ymd = formatDateCompact(course.date);
      const name = getCourseDisplayName(course);
      box.innerHTML = '';
      new QRCode(box, { text: url, width: 240, height: 240, correctLevel: QRCode.CorrectLevel.M });
      caption.textContent = `æƒæå¾Œæœƒé–‹å•Ÿ LINE ä¸¦å¸¶å…¥ã€Œå ±å ${ymd}${name}ã€è¨Šæ¯`;
      copyQrBtn.disabled = false; downloadQrBtn.disabled = false;
    }

    // çŸ­ç¶²å€
    async function shortenWithIsGd(longUrl){
      const endpoint = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`;
      const res = await fetch(endpoint);
      if(!res.ok) throw new Error('çŸ­ç¶²å€æœå‹™å›æ‡‰ç•°å¸¸');
      const data = await res.json();
      if (data.shorturl) return data.shorturl;
      throw new Error(data.errormessage || 'ç”¢ç”ŸçŸ­ç¶²å€å¤±æ•—');
    }
    async function updateUrlBoxes(course){
      const full = buildLineUrl(course);
      currentFullUrl = full || '';
      fullUrlInput.value = currentFullUrl;
      copyFullUrlBtn.disabled = !currentFullUrl;
      shortUrlInput.value = full ? 'ç”¢ç”Ÿä¸­â€¦' : '';
      copyShortUrlBtn.disabled = true;
      currentShortUrl = '';
      if (!full) return '';
      try{
        const shorted = await shortenWithIsGd(full);
        currentShortUrl = shorted || '';
        shortUrlInput.value = currentShortUrl || 'ï¼ˆç„¡æ³•ç”¢ç”Ÿï¼‰';
        copyShortUrlBtn.disabled = !currentShortUrl;
        return currentShortUrl;
      }catch{
        shortUrlInput.value = 'ï¼ˆç„¡æ³•ç”¢ç”Ÿï¼‰';
        copyShortUrlBtn.disabled = true;
        return '';
      }
    }

    // è§£æ rowsï¼Œä¸¦åœ¨éœ€è¦æ™‚å¸¶å‡ºé¤é£Ÿè²»
    function mapRowsToNeededColumns(values, wantMeal){
      if (!values || !values.values || !values.values.length) return { rows: [], hasMeal:false };
      const [header, ...data] = values.values;
      const norm = s => (s || "").toString().replace(/[\s\u3000]/g,"").toLowerCase();
      const idx = {}; header.forEach((h,i)=>idx[norm(h)] = i);

      const need = ["å§“å","é‚€è«‹äºº","ç¹³è²»ç‹€æ…‹","ç°½åˆ°","è¨»è¨˜"];
      const alias = { ç¹³è²»ç‹€æ…‹:["ç¹³è²»","ä»˜æ¬¾ç‹€æ…‹","æ˜¯å¦ç¹³è²»"], ç°½åˆ°:["æ˜¯å¦ç°½åˆ°","å‡ºå¸­"], é‚€è«‹äºº:["æ¨è–¦äºº","ä»‹ç´¹äºº"], è¨»è¨˜:["å‚™è¨»"] };
      const col = {};
      need.forEach(n=>{
        if (norm(n) in idx) col[n] = idx[norm(n)];
        else (alias[n]||[]).some(t => (norm(t) in idx) && (col[n] = idx[norm(t)], true));
      });

      // é¤é£Ÿè²»ï¼šåƒ…åœ¨ wantMeal æ™‚å°‹æ‰¾æ¬„ä½
      let mealIdx = -1;
      if (wantMeal){
        const mealNames = ["é¤é£Ÿè²»","é¤è²»","é¤é»è²»","é¤é»","ä¾¿ç•¶","é¤é£Ÿ"];
        for (const name of mealNames){ if (norm(name) in idx){ mealIdx = idx[norm(name)]; break; } }
      }

      const baseRow = 2; // å‡è¨­è³‡æ–™è‡ªç¬¬ 2 åˆ—
      const rows = data.map((row,i)=>{
        const r = {
          row_index: baseRow + i,
          å§“å: col["å§“å"]!=null ? (row[col["å§“å"]]||"") : "",
          é‚€è«‹äºº: col["é‚€è«‹äºº"]!=null ? (row[col["é‚€è«‹äºº"]]||"") : "",
          ç¹³è²»ç‹€æ…‹: col["ç¹³è²»ç‹€æ…‹"]!=null ? (row[col["ç¹³è²»ç‹€æ…‹"]]||"") : "",
          ç°½åˆ°: col["ç°½åˆ°"]!=null ? (row[col["ç°½åˆ°"]]||"") : "",
          è¨»è¨˜: col["è¨»è¨˜"]!=null ? (row[col["è¨»è¨˜"]]||"") : ""
        };
        if (mealIdx >= 0){
          const raw = row[mealIdx] || "";
          r.é¤é£Ÿè²» = normalizeMeal(raw); // åªæ”¾ã€Œå·²ç¹³ã€æˆ–ç©ºç™½
        }
        return r;
      }).filter(r => Object.values(r).some(v => String(v).trim() !== ""));

      return { rows, hasMeal: mealIdx >= 0 };
    }

    // é¸èª²ä¸»æµç¨‹
    async function selectCourse(course){
      selectedCourse = course;
      const displayName = getCourseDisplayName(course);
      courseTitle.textContent = `${course.title}ï½œ${formatDate(course.date)}`;
      refreshBtn.disabled = true;
      rosterTableBody.innerHTML = `<tr><td colspan="6" class="text-secondary">è¼‰å…¥ä¸­â€¦</td></tr>`;

      try{
        const values = await fetchSheetValuesByTitle(course.title);

        // æ¢ä»¶ï¼šèª²ç¨‹åç¨±å«ã€Œé¤å»³ã€æ‰éœ€è¦é¤é£Ÿè²»æ¬„
        const wantMeal = /é¤å»³/.test(course.title) || /é¤å»³/.test(displayName);

        // è½‰æ› rowsï¼Œä¸¦åµæ¸¬æ˜¯å¦å­˜åœ¨é¤é£Ÿè²»æ¬„
        const { rows, hasMeal } = mapRowsToNeededColumns(values, wantMeal);

        // åªæœ‰ç•¶ã€Œåç¨±å«é¤å»³ã€ä¸”è¡¨å…§çœŸçš„æœ‰é¤é£Ÿè²»æ¬„ä½ï¼Œæ‰é¡¯ç¤ºé¤é£Ÿè²»
        showMeal = !!(wantMeal && hasMeal);

        renderRoster(rows);

        const total = rows.length;
        const paid = rows.filter(r => isPaidValue(r["ç¹³è²»ç‹€æ…‹"])).length;
        updateCounters(total, paid);
        statusText.textContent = `å…± ${total} ç­†ï¼ˆå·²ç¹³ ${paid}ï¼‰`;
        location.hash = encodeURIComponent(course.title);

        // URL / QR / åˆ†äº«æ–‡å­—
        const shorted = await updateUrlBoxes(course);
        const full = buildLineUrl(course);
        updateQRCodeWithUrl(full, course);
        fillShareText(course, rows, shorted);

        editToggleBtn.disabled = false;
        saveChangesBtn.classList.toggle('d-none', !editMode);

      }catch(err){
        console.error(err);
        statusText.textContent = "è®€å–å¤±æ•—";
        renderRoster([]);
        fillShareText(null, [], "");
        fullUrlInput.value = ""; shortUrlInput.value = "";
        copyFullUrlBtn.disabled = true; copyShortUrlBtn.disabled = true;
        updateQRCodeWithUrl(null, null);
        editToggleBtn.disabled = true;
        saveChangesBtn.classList.add('d-none');
        showToast(err.message);
      }finally{
        refreshBtn.disabled = false;
      }
    }

    function renderAllCoursesDropdown(list){
      allCoursesMenu.innerHTML = "";
      if (!list.length){ allCoursesMenu.innerHTML = '<li class="px-3 py-2 text-secondary">æ²’æœ‰å³å°‡åˆ°ä¾†çš„èª²ç¨‹</li>'; return; }
      list.forEach(c=>{
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.className = "dropdown-item d-flex justify-content-between align-items-center";
        a.href = "#"; a.textContent = c.title;
        const badge = document.createElement("span");
        badge.className = "badge text-bg-light ms-2";
        badge.textContent = formatDate(c.date);
        a.appendChild(badge);
        a.addEventListener("click", e => { e.preventDefault(); selectCourse(c); });
        li.appendChild(a); allCoursesMenu.appendChild(li);
      });
    }
    function renderUpcomingFour(list){
      upcomingFour.innerHTML = "";
      const slice = list.slice(0,4);
      if (!slice.length){ upcomingFour.innerHTML = '<div class="col-12"><div class="text-secondary small">æ²’æœ‰å³å°‡åˆ°ä¾†çš„èª²ç¨‹</div></div>'; return; }
      slice.forEach(c=>{
        const col = document.createElement("div"); col.className = "col-12 col-sm-6 col-lg-3";
        const btn = document.createElement("button"); btn.className = "btn btn-outline-primary w-100 text-start";
        btn.innerHTML = `<div class="fw-semibold">${c.title}</div><div class="small text-secondary">${formatDate(c.date)}</div>`;
        btn.addEventListener("click", ()=>selectCourse(c));
        col.appendChild(btn); upcomingFour.appendChild(col);
      });
    }
    function renderSearchResults(list){
      if (!list || !list.length){ clearSearchResults(); return; }
      searchResultsWrap.classList.remove("d-none");
      searchResults.innerHTML = "";
      list.forEach(c=>{
        const col = document.createElement("div"); col.className = "col-12 col-sm-6 col-lg-3";
        const btn = document.createElement("button"); btn.className = "btn btn-outline-secondary w-100 text-start";
        btn.innerHTML = `<div class="fw-semibold">${c.title}</div><div class="small text-secondary">${formatDate(c.date)}</div>`;
        btn.addEventListener("click", ()=>selectCourse(c));
        col.appendChild(btn); searchResults.appendChild(col);
      });
    }
    function clearSearchResults(){ searchResults.innerHTML=""; searchResultsWrap.classList.add("d-none"); }

    // ===== ç·¨è¼¯æ¨¡å¼ï¼šç”¨ Bootstrap Modal é©—å¯† =====
    function enterEditModeWithPassword(){
      if (!selectedCourse){ showToast("è«‹å…ˆé¸æ“‡èª²ç¨‹"); return; }
      if (!editPwdModal) editPwdModal = new bootstrap.Modal(editPwdModalEl, { backdrop: 'static' });
      editPwdError.classList.add('d-none');
      editPwdInput.value = '';
      editPwdInput.type = 'password';
      togglePwdBtn.textContent = 'é¡¯ç¤º';
      editPwdModal.show();
      setTimeout(()=> editPwdInput.focus(), 150);
    }
    function confirmEditPassword(){
      const pwd = (editPwdInput.value || '').trim();
      if (pwd !== '1993'){
        editPwdError.classList.remove('d-none');
        editPwdInput.select();
        return;
      }
      editPwdModal.hide();
      editMode = true;
      editToggleBtn.textContent = "å®Œæˆç·¨è¼¯";
      saveChangesBtn.classList.remove('d-none');
      selectCourse(selectedCourse); // é‡æ–°æ¸²æŸ“ç‚ºå¯ç·¨è¼¯
      showToast('å·²é€²å…¥ä¿®æ”¹æ¨¡å¼');
    }
    function exitEditMode(){
      editMode = false;
      editToggleBtn.textContent = "ä¿®æ”¹è³‡æ–™";
      saveChangesBtn.classList.add('d-none');
      selectCourse(selectedCourse); // é‡æ–°æ¸²æŸ“ç‚ºå”¯è®€
      showToast('å·²é›¢é–‹ä¿®æ”¹æ¨¡å¼');
    }

    // åˆ—ä¸Šçš„é–‹é—œäº’å‹•
    rosterTableBody.addEventListener('click', (e)=>{
      const sw = e.target.closest('.switch');
      if(sw){
        sw.classList.toggle('on');
        sw.setAttribute('aria-checked', sw.classList.contains('on') ? 'true' : 'false');
      }
    });
    rosterTableBody.addEventListener('keydown', (e)=>{
      if(e.key === ' ' || e.key === 'Enter'){
        const sw = e.target.closest('.switch');
        if(sw){
          e.preventDefault();
          sw.classList.toggle('on');
          sw.setAttribute('aria-checked', sw.classList.contains('on') ? 'true' : 'false');
        }
      }
    });

    // ===== é€å‡ºä¿®æ”¹ï¼šè¡¨æ ¼é è¦½ + Bootstrap Modal ç¢ºèª =====
    function labelPaid(v){ return v ? v : 'æœªç¹³è²»'; }
    function labelMeal(v){ return v ? 'å·²ç¹³' : 'æœªç¹³'; }
    function labelChk(v){ return v ? 'å·²å ±åˆ°' : 'æœªå ±åˆ°'; }

    async function submitChanges(){
      if (!selectedCourse){ showToast('è«‹å…ˆé¸æ“‡èª²ç¨‹'); return; }

      const rows = Array.from(document.querySelectorAll('#rosterTable tbody tr.edit-row'));
      const changes = [];
      const previews = []; // [{name, paid:{old,new}, meal:{old,new}, checkin:{oldBool,newBool}, note:{old,new}}]

      rows.forEach(tr=>{
        const row_index = parseInt(tr.dataset.row,10);
        const name      = tr.dataset.name || '';

        const origPaid  = tr.dataset.paid || '';
        const origChk   = tr.dataset.checkin || ''; // 'å·²å ±åˆ°' or ''
        const origNote  = tr.dataset.note || '';
        const origMeal  = showMeal ? (tr.dataset.meal || '') : null;

        const paidSel = tr.querySelector('td[data-field="paid"] select');
        const curPaid = paidSel ? (paidSel.value || '') : '';

        const chkSw = tr.querySelector('td[data-field="checkin"] .switch');
        const curChk = (chkSw && chkSw.classList.contains('on')) ? 'å·²å ±åˆ°' : '';

        const noteIn = tr.querySelector('td[data-field="note"] input');
        const curNote = noteIn ? (noteIn.value || '') : '';

        let curMeal = null;
        if (showMeal){
          const mealSw = tr.querySelector('td[data-field="meal"] .switch');
          curMeal = mealSw ? (mealSw.classList.contains('on') ? 'å·²ç¹³' : '') : '';
        }

        const change = { row_index, name };
        const preview = { name };

        if (curPaid !== origPaid){ change.paid = curPaid; preview.paid = { old: origPaid, new: curPaid }; }
        if (showMeal && curMeal !== origMeal){ change.meal = curMeal; preview.meal = { old: !!origMeal, new: !!curMeal }; }
        if (curChk !== origChk){ change.checkin = curChk; preview.checkin = { old: !!origChk, new: !!curChk }; }
        if (curNote !== origNote){ change.note = curNote; preview.note = { old: origNote, new: curNote }; }

        if (Object.keys(change).length > 2){
          changes.push(change);
          previews.push(preview);
        }
      });

      if(!changes.length){ showToast('æ²’æœ‰å¯é€å‡ºçš„ä¿®æ”¹'); return; }

      // ç”¨è¡¨æ ¼é¡¯ç¤ºé è¦½ï¼Œé–‹å•Ÿç¢ºèªè¦–çª—
      buildConfirmTable(previews);
      confirmSummary.textContent = `å³å°‡é€å‡º ${previews.length} ç­†ä¿®æ”¹ï¼š`;
      if (!confirmModal) confirmModal = new bootstrap.Modal(confirmModalEl, { backdrop: 'static' });
      pendingChanges = { changes };
      confirmModal.show();
    }

    function buildConfirmTable(previews){
      // å‹•æ…‹è¡¨é ­
      const needMealCol = showMeal && previews.some(p => 'meal' in p);
      const headCells = [
        '<th style="width:160px">å§“å</th>',
        '<th style="width:180px">å…¥å ´è²»</th>',
        needMealCol ? '<th style="width:140px">é¤é£Ÿè²»</th>' : '',
        '<th style="width:140px">å ±åˆ°</th>',
        '<th>è¨»è¨˜</th>',
      ].join('');
      confirmTableHead.innerHTML = headCells;

      // è¡¨èº«
      confirmTableBody.innerHTML = '';
      previews.forEach(p=>{
        const tdName = `<td class="fw-semibold">${escapeHtml(p.name || '')}</td>`;

        const tdPaid = `<td class="oldnew">
          <div><small>åŸï¼š</small>${escapeHtml(labelPaid(p.paid?.old ?? ''))}</div>
          <div><small>æ–°ï¼š</small>${escapeHtml(labelPaid(p.paid?.new ?? ''))}</div>
        </td>`;

        const tdMeal = needMealCol ? `<td class="oldnew">
          <div><small>åŸï¼š</small>${('meal' in p) ? labelMeal(p.meal.old) : 'â€”'}</div>
          <div><small>æ–°ï¼š</small>${('meal' in p) ? labelMeal(p.meal.new) : 'â€”'}</div>
        </td>` : '';

        const tdChk = `<td class="oldnew">
          <div><small>åŸï¼š</small>${('checkin' in p) ? labelChk(p.checkin.old) : 'â€”'}</div>
          <div><small>æ–°ï¼š</small>${('checkin' in p) ? labelChk(p.checkin.new) : 'â€”'}</div>
        </td>`;

        const oldNote = p.note?.old ?? 'ï¼ˆç©ºï¼‰';
        const newNote = p.note?.new ?? 'ï¼ˆç©ºï¼‰';
        const tdNote = `<td class="oldnew">
          <div class="text-truncate" style="max-width:420px;"><small>åŸï¼š</small>${escapeHtml(oldNote) || 'ï¼ˆç©ºï¼‰'}</div>
          <div class="text-truncate" style="max-width:420px;"><small>æ–°ï¼š</small>${escapeHtml(newNote) || 'ï¼ˆç©ºï¼‰'}</div>
        </td>`;

        const tr = document.createElement('tr');
        tr.innerHTML = tdName + tdPaid + tdMeal + tdChk + tdNote;
        confirmTableBody.appendChild(tr);
      });
    }

    async function doSubmitPendingChanges(){
      if (!pendingChanges || !pendingChanges.changes?.length) return;

      // UIï¼šé–å®šæŒ‰éˆ• + spinner
      confirmSubmitBtn.disabled = true;
      confirmSpinner.classList.remove('d-none');

      try{
        const fd = new FormData();
        fd.append('sheet_title', selectedCourse?.title || '');
        fd.append('date_key', selectedCourse ? formatDateCompact(selectedCourse.date) : '');
        fd.append('course_name', selectedCourse ? getCourseDisplayName(selectedCourse) : '');
        fd.append('code', '');
        fd.append('payload', JSON.stringify({ changes: pendingChanges.changes }));

        const res = await fetch(SUBMIT_URL, { method:'POST', body:fd, credentials:'include' });
        if(!res.ok){
          const text = await res.text().catch(()=> '');
          throw new Error(`æäº¤å¤±æ•—ï¼ˆ${res.status}ï¼‰ï¼š${text.slice(0,200)}`);
        }

        // æˆåŠŸ
        confirmModal.hide();
        pendingChanges = null;
        showToast('å·²é€å‡ºä¿®æ”¹');
        exitEditMode();

      }catch(err){
        console.error(err);
        showToast(err.message || 'é€å‡ºå¤±æ•—');
      }finally{
        confirmSubmitBtn.disabled = false;
        confirmSpinner.classList.add('d-none');
      }
    }

    // æœå°‹ï¼ˆæ”¯æ´ all / ALL / å…¨éƒ¨ é¡¯ç¤ºæ‰€æœ‰èª²ç¨‹ï¼‰
    function applySearch(){
      const q = searchInput.value.trim();
      if (!q){ showToast("è«‹è¼¸å…¥é—œéµå­—"); return; }

      if (['all','å…¨éƒ¨'].includes(q.toLowerCase())){
        if (!courses.length){
          showToast("ç›®å‰æ²’æœ‰ä»»ä½•èª²ç¨‹");
          clearSearchResults();
          return;
        }
        renderSearchResults(courses);
        statusText.textContent = `å…± ${courses.length} å ‚èª²ç¨‹`;
        return;
      }

      const isDateLike = /^\d{8}$/.test(q);
      const matched = courses.filter(c =>
        isDateLike ? c.dateStr.includes(q) : c.title.toLowerCase().includes(q.toLowerCase())
      );

      if (!matched.length){
        showToast("æ‰¾ä¸åˆ°ç¬¦åˆçš„èª²ç¨‹");
        clearSearchResults();
        return;
      }
      renderSearchResults(matched);
      statusText.textContent = `æ‰¾åˆ° ${matched.length} å ‚èª²ç¨‹`;
    }

    // äº‹ä»¶
    searchBtn.addEventListener("click", applySearch);
    searchInput.addEventListener("keydown", e => { if (e.key === "Enter") applySearch(); });
    refreshBtn.addEventListener("click", () => { if (selectedCourse) selectCourse(selectedCourse); });
    clearSearchBtn.addEventListener("click", clearSearchResults);
    editToggleBtn.addEventListener("click", ()=>{ if (!editMode) enterEditModeWithPassword(); else exitEditMode(); });
    saveChangesBtn.addEventListener("click", submitChanges);

    // å¯†ç¢¼ Modal äº‹ä»¶
    togglePwdBtn.addEventListener('click', ()=>{
      if (editPwdInput.type === 'password'){
        editPwdInput.type = 'text';
        togglePwdBtn.textContent = 'éš±è—';
      } else {
        editPwdInput.type = 'password';
        togglePwdBtn.textContent = 'é¡¯ç¤º';
      }
    });
    editPwdConfirmBtn.addEventListener('click', confirmEditPassword);
    editPwdInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') confirmEditPassword(); });

    // ç¢ºèªé€å‡º Modal äº‹ä»¶
    confirmSubmitBtn.addEventListener('click', doSubmitPendingChanges);

    async function init(){
      if (!API_KEY || API_KEY.includes("YOUR_API_KEY")){
        statusText.textContent = "å°šæœªè¨­å®š API Keyï¼ˆè«‹ç·¨è¼¯åŸå§‹ç¢¼ï¼‰";
        showToast("è«‹å…ˆåœ¨åŸå§‹ç¢¼ä¸­è¨­å®š API_KEY");
      }
      if (location.protocol === "file:"){
        showToast("åµæ¸¬åˆ°ä»¥æª”æ¡ˆæ–¹å¼é–‹å•Ÿï¼›è‹¥ API Key æœ‰ã€Œç¶²ç«™é™åˆ¶ã€å¯èƒ½æœƒè¢«æ“‹ï¼Œå»ºè­°ç”¨æœ¬æ©Ÿä¼ºæœå™¨æˆ–éƒ¨ç½²åˆ°ç¶²åŸŸã€‚");
      }

      statusText.textContent = "è¼‰å…¥èª²ç¨‹ä¸­â€¦";
      try{
        const data = await fetchSheetsList();
        const sheets = (data.sheets || []).map(s => s.properties);
        courses = sheets
          .filter(s => isCourseSheet(s.title))
          .map(s => ({ title:s.title, dateStr:extractDateStr(s.title), date:yyyymmddToDate(extractDateStr(s.title)), sheetId:s.sheetId }))
          .sort((a,b)=> a.date - b.date);

        const today = new Date();
        futureCourses = courses.filter(c => c.date >= new Date(today.getFullYear(), today.getMonth(), today.getDate()));

        renderAllCoursesDropdown(futureCourses);
        renderUpcomingFour(futureCourses);
        statusText.textContent = `å…± ${courses.length} å€‹èª²ç¨‹åˆ†é ï¼ˆæœªä¾†ï¼š${futureCourses.length}ï¼‰`;

        if (location.hash){
          const t = decodeURIComponent(location.hash.slice(1));
          const hit = courses.find(c => c.title === t);
          if (hit) await selectCourse(hit);
          else if (futureCourses.length) await selectCourse(futureCourses[0]);
          else if (courses.length) await selectCourse(courses[courses.length-1]);
        } else if (futureCourses.length){
          await selectCourse(futureCourses[0]);
        } else if (courses.length){
          await selectCourse(courses[courses.length-1]);
        }
      }catch(err){
        console.error(err);
        statusText.textContent = "è¼‰å…¥èª²ç¨‹å¤±æ•—";
        showToast(err.message);
      }
    }
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
