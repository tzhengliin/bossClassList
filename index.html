<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>é«˜é›„åšå£«ç­ï½œèª²ç¨‹å ±åç³»çµ±ï½œå³æ™‚åå–®</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      .dropdown-menu-scroll { max-height: 320px; overflow-y: auto; }
      .cursor-pointer { cursor: pointer; }
      .shadow-soft { box-shadow: 0 0.5rem 1rem rgba(0,0,0,.08); }
      #qrContainer {
        width: 240px; height: 240px;
        display: flex; align-items: center; justify-content: center;
        background: #fff; border: 1px solid rgba(0,0,0,.1); border-radius: .5rem;
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="#">é«˜é›„åšå£«ç­ï½œèª²ç¨‹å ±ååå–®</a>
        <button class="btn btn-primary btn-sm">
          <a href="https://tzhengliin.synology.me/bossclass/verify" class="text-decoration-none text-white">ç°½åˆ°èªè­‰</a>
        </button>
      </div>
    </nav>

    <main class="container py-4">
      <!-- æœå°‹åˆ— -->
      <div class="card shadow-soft mb-3">
        <div class="card-body">
          <div class="row g-2 align-items-center">
            <div class="col-12 col-lg-8">
              <div class="input-group">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="allCoursesBtn">æ‰€æœ‰èª²ç¨‹</button>
                <ul class="dropdown-menu dropdown-menu-scroll" id="allCoursesMenu" aria-labelledby="allCoursesBtn">
                  <li class="px-3 py-2 text-secondary">è¼‰å…¥ä¸­â€¦</li>
                </ul>
                <input id="searchInput" type="text" class="form-control" placeholder="ç”¨æ—¥æœŸï¼ˆä¾‹å¦‚ 20250822ï¼‰æˆ–èª²ç¨‹åç¨±æœå°‹â€¦" aria-label="æœå°‹èª²ç¨‹" />
                <button id="searchBtn" class="btn btn-primary" type="button">æœå°‹</button>
              </div>
            </div>
            <div class="col-12 col-lg-4 text-lg-end">
              <small class="text-secondary" id="statusText">â€”</small>
            </div>
          </div>
        </div>
      </div>

      <!-- æœå°‹çµæœï¼ˆé¡¯ç¤ºåœ¨æœ€è¿‘å››å€‹èª²ç¨‹å‰ï¼‰ -->
      <div id="searchResultsWrap" class="mb-3 d-none">
        <div class="d-flex align-items-center justify-content-between">
          <h6 class="text-secondary mb-2">æœå°‹çµæœ</h6>
          <button id="clearSearchBtn" class="btn btn-link btn-sm p-0">æ¸…é™¤</button>
        </div>
        <div class="row g-2" id="searchResults"></div>
      </div>

      <!-- æœ€è¿‘å››å€‹èª²ç¨‹ -->
      <div class="mb-3">
        <h6 class="text-secondary mb-2">æœ€è¿‘å››å€‹èª²ç¨‹</h6>
        <div class="row g-2" id="upcomingFour"></div>
      </div>

      <!-- èª²ç¨‹æ¨™é¡Œ + è¨ˆæ•¸ + å·¥å…·åˆ— -->
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center gap-2">
          <h5 class="m-0" id="courseTitle">è«‹å¾ä¸Šæ–¹é¸æ“‡èª²ç¨‹</h5>
          <div id="courseCounters" class="d-none">
            <span class="badge text-bg-primary" id="countTotal">å ±å 0</span>
            <span class="badge text-bg-success ms-1" id="countPaid">å·²ç¹³ 0</span>
          </div>
        </div>
        <div><button id="refreshBtn" class="btn btn-outline-secondary btn-sm" disabled>é‡æ–°æ•´ç†</button></div>
      </div>

      <!-- è³‡æ–™è¡¨ -->
      <div class="card shadow-soft mb-3">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped align-middle" id="rosterTable">
              <thead>
                <tr>
                  <th style="width: 4rem">åºè™Ÿ</th>
                  <th style="min-width: 6rem">å§“å</th>
                  <th style="min-width: 6rem">é‚€è«‹äºº</th>
                  <th style="min-width: 6rem">ç¹³è²»ç‹€æ…‹</th>
                  <th style="min-width: 5rem">ç°½åˆ°</th>
                  <th style="min-width: 10rem">è¨»è¨˜</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="6" class="text-secondary">å°šæœªé¸å–èª²ç¨‹</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- å¿«é€Ÿè¤‡è£½æ–‡å­— -->
      <div class="card shadow-soft mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="m-0 text-secondary">å¿«é€Ÿè¤‡è£½æ–‡å­—</h6>
            <button id="copyBtn" class="btn btn-outline-primary btn-sm">è¤‡è£½</button>
          </div>
          <textarea id="shareText" class="form-control" rows="12" readonly placeholder="é¸å–èª²ç¨‹å¾Œï¼Œé€™è£¡æœƒè‡ªå‹•ç”¢ç”Ÿå¯è¤‡è£½çš„æ–‡å­—å…§å®¹"></textarea>
        </div>
      </div>

      <!-- å ±åé€£çµï¼ˆå®Œæ•´ç¶²å€ / çŸ­ç¶²å€ï¼‰ï¼‹ QRCode -->
      <div class="card shadow-soft">
        <div class="card-body">
          <!-- å®Œæ•´ç¶²å€ -->
          <div class="mb-2">
            <label class="form-label small text-secondary">å®Œæ•´ç¶²å€ï¼ˆLINE é–‹å•Ÿè¨Šæ¯ï¼‰</label>
            <div class="input-group">
              <input id="fullUrlInput" type="text" class="form-control" readonly placeholder="é¸æ“‡èª²ç¨‹å¾Œè‡ªå‹•ç”¢ç”Ÿ">
              <button id="copyFullUrlBtn" class="btn btn-outline-primary" type="button" disabled>è¤‡è£½</button>
            </div>
          </div>
          <!-- çŸ­ç¶²å€ -->
          <div class="mb-3">
            <label class="form-label small text-secondary">çŸ­ç¶²å€</label>
            <div class="input-group">
              <input id="shortUrlInput" type="text" class="form-control" readonly placeholder="é¸æ“‡èª²ç¨‹å¾Œè‡ªå‹•ç”¢ç”Ÿï¼ˆis.gd / v.gdï¼‰">
              <button id="copyShortUrlBtn" class="btn btn-outline-primary" type="button" disabled>è¤‡è£½</button>
            </div>
            <div id="shortUrlHint" class="form-text">è‹¥ç„¡æ³•ç”¢ç”Ÿï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ”¹ç”¨å®Œæ•´ç¶²å€ã€‚</div>
          </div>

          <!-- QR èˆ‡æ“ä½œ -->
          <div class="d-flex align-items-start gap-3 flex-wrap">
            <div>
              <div id="qrContainer"><span class="text-secondary small">è«‹å…ˆé¸æ“‡èª²ç¨‹</span></div>
              <div class="small text-secondary mt-2" id="qrCaption">å°‡ç”¢ç”Ÿï¼šLINE å‚³é€ã€Œå ±å {æ—¥æœŸ} {èª²ç¨‹åç¨±}ã€</div>
            </div>
            <div class="d-flex flex-column gap-2">
              <button id="copyQrBtn" class="btn btn-outline-primary btn-sm" disabled>è¤‡è£½åœ–ç‰‡</button>
              <button id="downloadQrBtn" class="btn btn-outline-secondary btn-sm" disabled>ä¸‹è¼‰åœ–ç‰‡</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
      <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">æç¤º</strong>
          <small class="text-muted">ç¾åœ¨</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">â€”</div>
      </div>
    </div>

    <!-- QRCode å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
      // === å¯èª¿æ•´åƒæ•¸ ===
      const SPREADSHEET_ID = "1dHKNksMN3jiB7EVCtgJLdCY3ggy2jokCMfNLCXmGNf4";
      const API_KEY = "YOUR_API_KEY_HERE";

      // === DOM ===
      const allCoursesMenu = document.getElementById("allCoursesMenu");
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const statusText = document.getElementById("statusText");
      const upcomingFour = document.getElementById("upcomingFour");
      const rosterTableBody = document.querySelector("#rosterTable tbody");
      const courseTitle = document.getElementById("courseTitle");
      const refreshBtn = document.getElementById("refreshBtn");
      const searchResultsWrap = document.getElementById("searchResultsWrap");
      const searchResults = document.getElementById("searchResults");
      const clearSearchBtn = document.getElementById("clearSearchBtn");
      const courseCounters = document.getElementById("courseCounters");
      const countTotalEl = document.getElementById("countTotal");
      const countPaidEl = document.getElementById("countPaid");
      const shareTextEl = document.getElementById("shareText");
      const copyBtn = document.getElementById("copyBtn");

      const fullUrlInput = document.getElementById("fullUrlInput");
      const copyFullUrlBtn = document.getElementById("copyFullUrlBtn");
      const shortUrlInput = document.getElementById("shortUrlInput");
      const copyShortUrlBtn = document.getElementById("copyShortUrlBtn");

      const copyQrBtn = document.getElementById("copyQrBtn");
      const downloadQrBtn = document.getElementById("downloadQrBtn");

      // === ç‹€æ…‹ ===
      let courses = []; // { title, dateStr, date, sheetId }
      let futureCourses = [];
      let selectedCourse = null;

      // ===== å·¥å…· =====
      function showToast(msg) {
        document.getElementById("toastBody").textContent = msg;
        new bootstrap.Toast(document.getElementById("toast")).show();
      }
      function yyyymmddToDate(str) { return new Date(+str.slice(0,4), +str.slice(4,6)-1, +str.slice(6,8)); }
      function formatDate(date) {
        const y = date.getFullYear(), m = String(date.getMonth()+1).padStart(2,'0'), d = String(date.getDate()).padStart(2,'0');
        return `${y}/${m}/${d}`;
      }
      function isCourseSheet(title) { return /^\d{8}/.test(title); }
      function extractDateStr(title) { return title.slice(0,8); }
      function escapeHtml(str) { return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }
      function getCourseDisplayName(course) {
        const raw = course?.title || "";
        const noDate = raw.replace(/^\d{8}/, "").trim();
        return noDate || raw;
      }
      function explainFetchError(status, text) {
        if (status === 403) {
          if (/The caller does not have permission|Permission denied|insufficient permissions/i.test(text)) {
            return "æ¬Šé™ä¸è¶³ï¼šè«‹æŠŠè©¦ç®—è¡¨å…±ç”¨è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äºº â†’ æª¢è¦–è€…ã€ã€‚";
          }
          if (/Referer.*not.*allowed|API keys with referer restrictions cannot be used/i.test(text)) {
            return "API Key ä¾†æºé™åˆ¶ï¼šè«‹åœ¨ API Key é™åˆ¶åŠ å…¥ç›®å‰ç¶²åŸŸï¼ˆGitHub Pages / http://localhost/*ï¼‰ã€‚";
          }
        }
        if (status === 400 && /API key not valid/i.test(text)) return "API Key ç„¡æ•ˆæˆ–æœªå•Ÿç”¨ Sheets APIã€‚";
        return `è®€å–å¤±æ•—ï¼ˆ${status}ï¼‰ï¼š${text.slice(0,180)}...`;
      }
      function isPaidValue(val) {
        const s = String(val||"").replace(/\s+/g,"").toLowerCase();
        if (!s) return false;
        if (["y","yes","true","1","paid"].includes(s)) return true;
        if (s.includes("å·²ç¹³")||s.includes("å·²ä»˜æ¬¾")||s.includes("å·²ä»˜")||s.includes("ç¹³æ¸…")||s.includes("ä»˜æ¬¾å®Œæˆ")||s==="æ˜¯"||s==="æœ‰") return true;
        return false;
      }
      function paymentIcon(val) {
        const s = String(val||"").trim().toLowerCase().replace(/\s+/g,"");
        if (s.includes("é•·å®¢")||s.includes("é•·å®¢åˆ¸")) return "ğŸ”–";
        if (s.includes("linepay")||s.includes("line-pay")||s.includes("lineæ”¯ä»˜")||s.includes("â“")) return "â“";
        if (s.includes("ç¾é‡‘")||s.includes("å·²ç¹³")||s.includes("å·²ä»˜")||s.includes("å·²ä»˜æ¬¾")||s.includes("ç¹³æ¸…")||s.includes("ä»˜æ¸…")||s.includes("ä»˜æ¬¾å®Œæˆ")||["paid","cash","y","yes","1","true"].includes(s)) return "ğŸ’°";
        return "";
      }
      function checkinIcon(val) {
        const s = String(val||"").trim().toLowerCase();
        if (s.includes("å·²å ±åˆ°")||s.includes("å·²ç°½åˆ°")||["æ˜¯","y","yes","1","true","v","âœ“","âˆš"].includes(s)) return "âœ…";
        return "";
      }

      // ===== API =====
      async function fetchSheetsList() {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets(properties(sheetId%2Ctitle))&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(explainFetchError(res.status, await res.text()));
        return res.json();
      }
      async function fetchSheetValuesByTitle(title) {
        const range = `${encodeURIComponent(title)}!A1:Z2000`;
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?majorDimension=ROWS&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(explainFetchError(res.status, await res.text()));
        return res.json();
      }

      // ===== Renderers =====
      function renderAllCoursesDropdown(list) {
        allCoursesMenu.innerHTML = "";
        if (!list.length) { allCoursesMenu.innerHTML = '<li class="px-3 py-2 text-secondary">æ²’æœ‰å³å°‡åˆ°ä¾†çš„èª²ç¨‹</li>'; return; }
        list.forEach(c => {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.className = "dropdown-item d-flex justify-content-between align-items-center";
          a.href = "#"; a.textContent = c.title;
          const badge = document.createElement("span");
          badge.className = "badge text-bg-light ms-2";
          badge.textContent = formatDate(c.date);
          a.appendChild(badge);
          a.addEventListener("click", e => { e.preventDefault(); selectCourse(c); });
          li.appendChild(a); allCoursesMenu.appendChild(li);
        });
      }
      function renderUpcomingFour(list) {
        upcomingFour.innerHTML = "";
        const slice = list.slice(0,4);
        if (!slice.length) { upcomingFour.innerHTML = '<div class="col-12"><div class="text-secondary small">æ²’æœ‰å³å°‡åˆ°ä¾†çš„èª²ç¨‹</div></div>'; return; }
        slice.forEach(c => {
          const col = document.createElement("div"); col.className = "col-12 col-sm-6 col-lg-3";
          const btn = document.createElement("button"); btn.className = "btn btn-outline-primary w-100 text-start";
          btn.innerHTML = `<div class="fw-semibold">${c.title}</div><div class="small text-secondary">${formatDate(c.date)}</div>`;
          btn.addEventListener("click", () => selectCourse(c));
          col.appendChild(btn); upcomingFour.appendChild(col);
        });
      }
      function renderSearchResults(list) {
        if (!list || !list.length) { clearSearchResults(); return; }
        searchResultsWrap.classList.remove("d-none");
        searchResults.innerHTML = "";
        list.forEach(c => {
          const col = document.createElement("div"); col.className = "col-12 col-sm-6 col-lg-3";
          const btn = document.createElement("button"); btn.className = "btn btn-outline-secondary w-100 text-start";
          btn.innerHTML = `<div class="fw-semibold">${c.title}</div><div class="small text-secondary">${formatDate(c.date)}</div>`;
          btn.addEventListener("click", () => selectCourse(c));
          col.appendChild(btn); searchResults.appendChild(col);
        });
      }
      function clearSearchResults() { searchResults.innerHTML = ""; searchResultsWrap.classList.add("d-none"); }
      function renderRoster(rows) {
        rosterTableBody.innerHTML = "";
        if (!rows.length) { rosterTableBody.innerHTML = '<tr><td colspan="6" class="text-secondary">å°šç„¡è³‡æ–™</td></tr>'; return; }
        rows.forEach((r, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="text-secondary">${i + 1}</td>
            <td>${escapeHtml(r.å§“å ?? "")}</td>
            <td>${escapeHtml(r.é‚€è«‹äºº ?? "")}</td>
            <td>${escapeHtml(r.ç¹³è²»ç‹€æ…‹ ?? "")}</td>
            <td>${escapeHtml(r.ç°½åˆ° ?? "")}</td>
            <td>${escapeHtml(r.è¨»è¨˜ ?? "")}</td>
          `;
          rosterTableBody.appendChild(tr);
        });
      }
      function updateCounters(total, paid) {
        countTotalEl.textContent = `å ±å ${total}`;
        countPaidEl.textContent = `å·²ç¹³ ${paid}`;
        courseCounters.classList.remove("d-none");
      }

      // ===== ç”¢ç”Ÿå¯è¤‡è£½æ–‡å­— =====
      function buildShareText(course, rows) {
        if (!course) return "";
        const dateStr = formatDate(course.date);
        const courseName = getCourseDisplayName(course);
        const header = [
          `èª²ç¨‹æ—¥æœŸï¼š${dateStr}`,
          `èª²ç¨‹åç¨±ï¼š${courseName}`,
          `ğŸ’°ï¼šç¾é‡‘/å·²ç¹³è²»     â“ï¼šLinepay`,
          `ğŸ”–ï¼šé•·å®¢åˆ¸            âœ…ï¼šå®Œæˆå ±åˆ°`,
          `--------------`,
          `äººå“¡æ¸…å–®ï¼š`
        ];
        const body = rows.map((r, i) => {
          const name = r.å§“å || "";
          const inviter = r.é‚€è«‹äºº || "";
          const payIcon = paymentIcon(r.ç¹³è²»ç‹€æ…‹);
          const checkIcon = checkinIcon(r.ç°½åˆ°);
          const inviterText = inviter ? `(${inviter})` : "";
          return `${i + 1}.${name}${inviterText}${payIcon}${checkIcon}`;
        });
        return [...header, ...body].join("\n");
      }
      function fillShareText(course, rows) { shareTextEl.value = buildShareText(course, rows); }

      // ===== QR èˆ‡ URL =====
      function buildLineUrl(course) {
        if (!course) return "";
        const dateStr = formatDate(course.date);
        const cName = getCourseDisplayName(course);
        // å ±å {æ—¥æœŸ} {èª²ç¨‹åç¨±}
        const msg = `å ±å ${dateStr} ${cName}`;
        return `https://line.me/R/oaMessage/%40667xkonq/?${encodeURIComponent(msg)}`;
      }
      function getQrCanvas() {
        const box = document.getElementById('qrContainer');
        let canvas = box.querySelector('canvas');
        if (canvas) return canvas;
        const img = box.querySelector('img');
        if (!img) return null;
        const cv = document.createElement('canvas');
        const w = img.naturalWidth || 240, h = img.naturalHeight || 240;
        cv.width = w; cv.height = h;
        const ctx = cv.getContext('2d');
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
        ctx.drawImage(img, 0, 0, w, h);
        return cv;
      }
      function updateQRCodeWithUrl(url, captionText) {
        const box = document.getElementById('qrContainer');
        const caption = document.getElementById('qrCaption');
        if (!url) {
          box.innerHTML = '<span class="text-secondary small">è«‹å…ˆé¸æ“‡èª²ç¨‹</span>';
          caption.textContent = 'å°‡ç”¢ç”Ÿï¼šLINE å‚³é€ã€Œå ±å {æ—¥æœŸ} {èª²ç¨‹åç¨±}ã€';
          copyQrBtn.disabled = true; downloadQrBtn.disabled = true;
          return;
        }
        box.innerHTML = '';
        new QRCode(box, { text: url, width: 240, height: 240, correctLevel: QRCode.CorrectLevel.M });
        caption.textContent = captionText || 'æƒæå¾Œæœƒé–‹å•Ÿ LINE ä¸¦å¸¶å…¥è¨Šæ¯';
        copyQrBtn.disabled = false; downloadQrBtn.disabled = false;
      }
      async function shortenUrl(longUrl) {
        // å…ˆè©¦ is.gdï¼ˆsimple æ–‡å­—ï¼‰ï¼Œå¤±æ•—å†è©¦ v.gd
        try {
          const r = await fetch(`https://is.gd/create.php?format=simple&url=${encodeURIComponent(longUrl)}`);
          if (r.ok) {
            const t = (await r.text()).trim();
            if (t && /^https?:\/\//i.test(t)) return t;
          }
          throw new Error('is.gd å¤±æ•—');
        } catch (_) {
          try {
            const r2 = await fetch(`https://v.gd/create.php?format=simple&url=${encodeURIComponent(longUrl)}`);
            if (r2.ok) {
              const t2 = (await r2.text()).trim();
              if (t2 && /^https?:\/\//i.test(t2)) return t2;
            }
            throw new Error('v.gd å¤±æ•—');
          } catch (e) {
            console.warn('çŸ­ç¶²å€æœå‹™å¤±æ•—ï¼š', e);
            return '';
          }
        }
      }
      async function updateUrlBoxes(course) {
        const full = buildLineUrl(course);
        fullUrlInput.value = full || '';
        copyFullUrlBtn.disabled = !full;

        shortUrlInput.value = 'ç”¢ç”Ÿä¸­â€¦';
        copyShortUrlBtn.disabled = true;

        if (!full) {
          shortUrlInput.value = '';
          return;
        }
        const shorted = await shortenUrl(full);
        if (shorted) {
          shortUrlInput.value = shorted;
          copyShortUrlBtn.disabled = false;
        } else {
          shortUrlInput.value = 'ï¼ˆç„¡æ³•ç”¢ç”Ÿï¼‰';
          copyShortUrlBtn.disabled = true;
        }
      }

      // ===== ä¸»æµç¨‹ =====
      async function selectCourse(course) {
        selectedCourse = course;
        courseTitle.textContent = `${course.title}ï½œ${formatDate(course.date)}`;
        refreshBtn.disabled = true;
        rosterTableBody.innerHTML = '<tr><td colspan="6" class="text-secondary">è¼‰å…¥ä¸­â€¦</td></tr>';
        try {
          const values = await fetchSheetValuesByTitle(course.title);
          const rows = mapRowsToNeededColumns(values);
          renderRoster(rows);

          const total = rows.length;
          const paid = rows.filter(r => isPaidValue(r["ç¹³è²»ç‹€æ…‹"])).length;
          updateCounters(total, paid);
          statusText.textContent = `å…± ${total} ç­†ï¼ˆå·²ç¹³ ${paid}ï¼‰`;
          location.hash = encodeURIComponent(course.title);

          fillShareText(course, rows);

          const full = buildLineUrl(course);
          await updateUrlBoxes(course);
          updateQRCodeWithUrl(full, `æƒæå¾Œæœƒé–‹å•Ÿ LINE ä¸¦å¸¶å…¥ã€Œå ±å ${formatDate(course.date)} ${getCourseDisplayName(course)}ã€`);
        } catch (err) {
          console.error(err);
          statusText.textContent = "è®€å–å¤±æ•—";
          renderRoster([]);
          fillShareText(null, []);
          updateUrlBoxes(null);
          updateQRCodeWithUrl(null);
          showToast(err.message);
        } finally {
          refreshBtn.disabled = false;
        }
      }

      function mapRowsToNeededColumns(values) {
        if (!values || !values.values || !values.values.length) return [];
        const [header, ...data] = values.values;
        const norm = s => (s || "").toString().replace(/[\s\u3000]/g,"").toLowerCase();
        const idx = {}; header.forEach((h,i)=>idx[norm(h)] = i);
        const need = ["å§“å","é‚€è«‹äºº","ç¹³è²»ç‹€æ…‹","ç°½åˆ°","è¨»è¨˜"];
        const miss = need.filter(n=>!(norm(n) in idx));
        if (miss.length) {
          const alias = { ç¹³è²»ç‹€æ…‹:["ç¹³è²»","ä»˜æ¬¾ç‹€æ…‹","æ˜¯å¦ç¹³è²»"], ç°½åˆ°:["æ˜¯å¦ç°½åˆ°","å‡ºå¸­"], é‚€è«‹äºº:["æ¨è–¦äºº","ä»‹ç´¹äºº"] };
          miss.forEach(n => { (alias[n]||[]).some(t => (norm(t) in idx) && (idx[norm(n)] = idx[norm(t)], true)); });
        }
        const rows = data.map(row => ({
          å§“å: row[idx[norm("å§“å")]] || "",
          é‚€è«‹äºº: row[idx[norm("é‚€è«‹äºº")]] || "",
          ç¹³è²»ç‹€æ…‹: row[idx[norm("ç¹³è²»ç‹€æ…‹")]] || "",
          ç°½åˆ°: row[idx[norm("ç°½åˆ°")]] || "",
          è¨»è¨˜: row[idx[norm("è¨»è¨˜")]] || ""
        }));
        return rows.filter(r => Object.values(r).some(v => String(v).trim() !== ""));
      }

      function applySearch() {
        const q = searchInput.value.trim();
        if (!q) { showToast("è«‹è¼¸å…¥é—œéµå­—"); return; }
        const isDateLike = /^\d{8}$/.test(q);
        const matched = courses.filter(c => isDateLike ? c.dateStr.includes(q) : c.title.toLowerCase().includes(q.toLowerCase()));
        if (!matched.length) { showToast("æ‰¾ä¸åˆ°ç¬¦åˆçš„èª²ç¨‹"); clearSearchResults(); return; }
        renderSearchResults(matched);
        statusText.textContent = `æ‰¾åˆ° ${matched.length} å ‚èª²ç¨‹`;
      }

      async function init() {
        if (!API_KEY || API_KEY.includes("YOUR_API_KEY")) {
          statusText.textContent = "å°šæœªè¨­å®š API Keyï¼ˆè«‹ç·¨è¼¯åŸå§‹ç¢¼ï¼‰";
          showToast("è«‹å…ˆåœ¨åŸå§‹ç¢¼ä¸­è¨­å®š API_KEY");
        }
        if (location.protocol === "file:") {
          showToast("åµæ¸¬åˆ°ä»¥æª”æ¡ˆæ–¹å¼é–‹å•Ÿï¼›è‹¥ API Key æœ‰ã€Œç¶²ç«™é™åˆ¶ã€å¯èƒ½æœƒè¢«æ“‹ï¼Œå»ºè­°ç”¨æœ¬æ©Ÿä¼ºæœå™¨æˆ–éƒ¨ç½²åˆ°ç¶²åŸŸã€‚");
        }

        statusText.textContent = "è¼‰å…¥èª²ç¨‹ä¸­â€¦";
        try {
          const data = await fetchSheetsList();
          const sheets = (data.sheets || []).map(s => s.properties);
          courses = sheets
            .filter(s => isCourseSheet(s.title))
            .map(s => ({ title: s.title, dateStr: extractDateStr(s.title), date: yyyymmddToDate(extractDateStr(s.title)), sheetId: s.sheetId }))
            .sort((a,b) => a.date - b.date);

          const today = new Date();
          futureCourses = courses.filter(c => c.date >= new Date(today.getFullYear(), today.getMonth(), today.getDate()));

          renderAllCoursesDropdown(futureCourses);
          renderUpcomingFour(futureCourses);
          statusText.textContent = `å…± ${courses.length} å€‹èª²ç¨‹åˆ†é ï¼ˆæœªä¾†ï¼š${futureCourses.length}ï¼‰`;

          if (location.hash) {
            const t = decodeURIComponent(location.hash.slice(1));
            const hit = courses.find(c => c.title === t);
            if (hit) selectCourse(hit);
            else if (futureCourses.length) selectCourse(futureCourses[0]);
            else if (courses.length) selectCourse(courses[courses.length-1]);
          } else if (futureCourses.length) {
            selectCourse(futureCourses[0]);
          } else if (courses.length) {
            selectCourse(courses[courses.length-1]);
          }
        } catch (err) {
          console.error(err);
          statusText.textContent = "è¼‰å…¥èª²ç¨‹å¤±æ•—";
          showToast(err.message);
        }
      }

      // äº‹ä»¶
      searchBtn.addEventListener("click", applySearch);
      searchInput.addEventListener("keydown", e => { if (e.key === "Enter") applySearch(); });
      refreshBtn.addEventListener("click", () => { if (selectedCourse) selectCourse(selectedCourse); });
      clearSearchBtn.addEventListener("click", clearSearchResults);

      copyBtn.addEventListener("click", async () => {
        try {
          if (navigator.clipboard && window.isSecureContext) await navigator.clipboard.writeText(shareTextEl.value);
          else { shareTextEl.select(); document.execCommand("copy"); shareTextEl.blur(); }
          showToast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
        } catch { showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•å…¨é¸è¤‡è£½"); }
      });

      copyFullUrlBtn.addEventListener("click", async () => {
        try { await navigator.clipboard.writeText(fullUrlInput.value); showToast("å®Œæ•´ç¶²å€å·²è¤‡è£½"); }
        catch { showToast("ç„¡æ³•è¤‡è£½å®Œæ•´ç¶²å€"); }
      });
      copyShortUrlBtn.addEventListener("click", async () => {
        try { await navigator.clipboard.writeText(shortUrlInput.value); showToast("çŸ­ç¶²å€å·²è¤‡è£½"); }
        catch { showToast("ç„¡æ³•è¤‡è£½çŸ­ç¶²å€"); }
      });

      copyQrBtn.addEventListener("click", async () => {
        try {
          const canvas = getQrCanvas();
          if (!canvas) { showToast('æ‰¾ä¸åˆ° QR åœ–ç‰‡'); return; }
          const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
          if (!blob || !navigator.clipboard || !window.ClipboardItem) throw new Error('Clipboard API ä¸æ”¯æ´');
          await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          showToast('QR åœ–ç‰‡å·²è¤‡è£½');
        } catch {
          showToast('ç„¡æ³•è¤‡è£½åœ–ç‰‡ï¼ˆç€è¦½å™¨æˆ–ç’°å¢ƒä¸æ”¯æ´ï¼‰');
        }
      });
      downloadQrBtn.addEventListener("click", () => {
        const canvas = getQrCanvas();
        if (!canvas) { showToast('æ‰¾ä¸åˆ° QR åœ–ç‰‡'); return; }
        const a = document.createElement('a');
        const cName = getCourseDisplayName(selectedCourse) || 'course';
        a.download = `qr-${cName}.png`;
        a.href = canvas.toDataURL('image/png');
        a.click();
      });

      // å•Ÿå‹•
      document.addEventListener("DOMContentLoaded", init);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
