<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>課程報名系統｜即時名單</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      .dropdown-menu-scroll {
        max-height: 320px;
        overflow-y: auto;
      }
      .cursor-pointer {
        cursor: pointer;
      }
      .shadow-soft {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="#">課程報名名單</a>
      </div>
    </nav>

    <main class="container py-4">
      <!-- 搜尋列 -->
      <div class="card shadow-soft mb-3">
        <div class="card-body">
          <div class="row g-2 align-items-center">
            <div class="col-12 col-lg-8">
              <div class="input-group">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="allCoursesBtn">所有課程</button>
                <ul class="dropdown-menu dropdown-menu-scroll" id="allCoursesMenu" aria-labelledby="allCoursesBtn">
                  <li class="px-3 py-2 text-secondary">載入中…</li>
                </ul>
                <input id="searchInput" type="text" class="form-control" placeholder="用日期（例如 20250822）或課程名稱搜尋…" aria-label="搜尋課程" />
                <button id="searchBtn" class="btn btn-primary" type="button">搜尋</button>
              </div>
            </div>
            <div class="col-12 col-lg-4 text-lg-end">
              <small class="text-secondary" id="statusText">—</small>
            </div>
          </div>
        </div>
      </div>

      <!-- 搜尋結果（顯示在最近四個課程前） -->
      <div id="searchResultsWrap" class="mb-3 d-none">
        <div class="d-flex align-items-center justify-content-between">
          <h6 class="text-secondary mb-2">搜尋結果</h6>
          <button id="clearSearchBtn" class="btn btn-link btn-sm p-0">清除</button>
        </div>
        <div class="row g-2" id="searchResults"></div>
      </div>

      <!-- 最近四個課程 -->
      <div class="mb-3">
        <h6 class="text-secondary mb-2">最近四個課程</h6>
        <div class="row g-2" id="upcomingFour"></div>
      </div>

      <!-- 課程標題 + 計數 + 工具列 -->
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center gap-2">
          <h5 class="m-0" id="courseTitle">請從上方選擇課程</h5>
          <div id="courseCounters" class="d-none">
            <span class="badge text-bg-primary" id="countTotal">報名 0</span>
            <span class="badge text-bg-success ms-1" id="countPaid">已繳 0</span>
          </div>
        </div>
        <div>
          <button id="refreshBtn" class="btn btn-outline-secondary btn-sm" disabled>重新整理</button>
        </div>
      </div>

      <!-- 資料表 -->
      <div class="card shadow-soft mb-3">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped align-middle" id="rosterTable">
              <thead>
                <tr>
                  <th style="width: 4rem">序號</th>
                  <th style="min-width: 6rem">姓名</th>
                  <th style="min-width: 6rem">邀請人</th>
                  <th style="min-width: 6rem">繳費狀態</th>
                  <th style="min-width: 5rem">簽到</th>
                  <th style="min-width: 10rem">註記</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="6" class="text-secondary">尚未選取課程</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 快速複製文字 -->
      <div class="card shadow-soft">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="m-0 text-secondary">快速複製文字</h6>
            <button id="copyBtn" class="btn btn-outline-primary btn-sm">複製</button>
          </div>
          <textarea id="shareText" class="form-control" rows="12" readonly placeholder="選取課程後，這裡會自動產生可複製的文字內容"></textarea>
        </div>
      </div>
    </main>

    <!-- Toast: 訊息提示 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
      <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">提示</strong>
          <small class="text-muted">現在</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">—</div>
      </div>
    </div>

    <script>
      // === 可調整參數 ===
      const SPREADSHEET_ID = "1dHKNksMN3jiB7EVCtgJLdCY3ggy2jokCMfNLCXmGNf4";
      const API_KEY = "AIzaSyDy5xNMYYqI_aBSMNHbp5tNcPCl84NS2Nc"; // ← 替換為你的 Google API Key

      // === DOM 元素 ===
      const allCoursesMenu = document.getElementById("allCoursesMenu");
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const statusText = document.getElementById("statusText");
      const upcomingFour = document.getElementById("upcomingFour");
      const rosterTableBody = document.querySelector("#rosterTable tbody");
      const courseTitle = document.getElementById("courseTitle");
      const refreshBtn = document.getElementById("refreshBtn");
      const searchResultsWrap = document.getElementById("searchResultsWrap");
      const searchResults = document.getElementById("searchResults");
      const clearSearchBtn = document.getElementById("clearSearchBtn");
      const courseCounters = document.getElementById("courseCounters");
      const countTotalEl = document.getElementById("countTotal");
      const countPaidEl = document.getElementById("countPaid");
      const shareTextEl = document.getElementById("shareText");
      const copyBtn = document.getElementById("copyBtn");

      // === 狀態 ===
      let courses = []; // { title, dateStr: 'YYYYMMDD', date: Date, sheetId }
      let futureCourses = [];
      let selectedCourse = null;

      // ===== 小工具 =====
      function showToast(msg) {
        document.getElementById("toastBody").textContent = msg;
        const toastEl = document.getElementById("toast");
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      }
      function yyyymmddToDate(str) {
        const y = +str.slice(0, 4),
          m = +str.slice(4, 6) - 1,
          d = +str.slice(6, 8);
        return new Date(y, m, d);
      }
      function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}/${m}/${d}`;
      }
      function isCourseSheet(title) {
        return /^\d{8}/.test(title);
      }
      function extractDateStr(title) {
        return title.slice(0, 8);
      }
      function escapeHtml(str) {
        return String(str).replace(/[&<>"]/g, (s) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[s]));
      }
      function explainFetchError(status, text) {
        if (status === 403) {
          if (/The caller does not have permission|Permission denied|insufficient permissions/i.test(text)) {
            return "權限不足：請把試算表共用設定為「知道連結的任何人 → 檢視者」。";
          }
          if (/Referer.*not.*allowed|API keys with referer restrictions cannot be used/i.test(text)) {
            return "API Key 來源限制：請在 API Key 限制中加入目前網域（GitHub Pages 或 http://localhost/*）。";
          }
        }
        if (status === 400 && /API key not valid/i.test(text)) return "API Key 無效或未啟用 Sheets API。";
        return `讀取失敗（${status}）：${text.slice(0, 180)}...`;
      }
      function isPaidValue(val) {
        const s = String(val || "")
          .replace(/\s+/g, "")
          .toLowerCase();
        if (!s) return false;
        if (["y", "yes", "true", "1", "paid"].includes(s)) return true;
        if (s.includes("已繳") || s.includes("已付款") || s.includes("已付") || s.includes("繳清") || s.includes("付款完成") || s === "是" || s === "有") return true;
        return false;
      }

      function paymentIcon(val) {
        const s = String(val || "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "");
        // 優先順序：長客券 > Linepay > 現金/已繳
        if (s.includes("長客") || s.includes("長客券")) return "🔖";
        if (s.includes("linepay") || s.includes("line-pay") || s.includes("line支付") || s.includes("Ⓛ")) return "Ⓛ";
        if (
          s.includes("現金") ||
          s.includes("已繳") ||
          s.includes("已付") ||
          s.includes("已付款") ||
          s.includes("繳清") ||
          s.includes("付清") ||
          s.includes("付款完成") ||
          s === "paid" ||
          s === "cash" ||
          s === "y" ||
          s === "yes" ||
          s === "1" ||
          s === "true"
        )
          return "💰";
        return ""; // 沒命中就不顯示圖示
      }

      function checkinIcon(val) {
        const s = String(val || "")
          .trim()
          .toLowerCase();
        // 常見「已報到」/「已簽到」/勾選表達
        if (s.includes("已報到") || s.includes("已簽到") || s === "是" || s === "y" || s === "yes" || s === "1" || s === "true" || s === "v" || s === "✓" || s === "√") {
          return "✅";
        }
        return ""; // 未報到不顯示
      }
      // ===== API =====
      async function fetchSheetsList() {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets(properties(sheetId%2Ctitle))&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(explainFetchError(res.status, text));
        }
        return res.json();
      }
      async function fetchSheetValuesByTitle(title) {
        const range = `${encodeURIComponent(title)}!A1:Z2000`;
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?majorDimension=ROWS&key=${API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(explainFetchError(res.status, text));
        }
        return res.json();
      }

      // ===== Renderers =====
      function renderAllCoursesDropdown(list) {
        allCoursesMenu.innerHTML = "";
        if (!list.length) {
          allCoursesMenu.innerHTML = '<li class="px-3 py-2 text-secondary">沒有即將到來的課程</li>';
          return;
        }
        list.forEach((c) => {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.className = "dropdown-item d-flex justify-content-between align-items-center";
          a.href = "#";
          a.textContent = c.title;
          const badge = document.createElement("span");
          badge.className = "badge text-bg-light ms-2";
          badge.textContent = formatDate(c.date);
          a.appendChild(badge);
          a.addEventListener("click", (e) => {
            e.preventDefault();
            selectCourse(c);
          });
          li.appendChild(a);
          allCoursesMenu.appendChild(li);
        });
      }
      function renderUpcomingFour(list) {
        upcomingFour.innerHTML = "";
        const slice = list.slice(0, 4);
        if (!slice.length) {
          upcomingFour.innerHTML = '<div class="col-12"><div class="text-secondary small">沒有即將到來的課程</div></div>';
          return;
        }
        slice.forEach((c) => {
          const col = document.createElement("div");
          col.className = "col-12 col-sm-6 col-lg-3";
          const btn = document.createElement("button");
          btn.className = "btn btn-outline-primary w-100 text-start";
          btn.innerHTML = `<div class="fw-semibold">${c.title}</div><div class="small text-secondary">${formatDate(c.date)}</div>`;
          btn.addEventListener("click", () => selectCourse(c));
          col.appendChild(btn);
          upcomingFour.appendChild(col);
        });
      }
      function renderSearchResults(list) {
        if (!list || !list.length) {
          clearSearchResults();
          return;
        }
        searchResultsWrap.classList.remove("d-none");
        searchResults.innerHTML = "";
        list.forEach((c) => {
          const col = document.createElement("div");
          col.className = "col-12 col-sm-6 col-lg-3";
          const btn = document.createElement("button");
          btn.className = "btn btn-outline-secondary w-100 text-start";
          btn.innerHTML = `<div class="fw-semibold">${c.title}</div><div class="small text-secondary">${formatDate(c.date)}</div>`;
          btn.addEventListener("click", () => selectCourse(c));
          col.appendChild(btn);
          searchResults.appendChild(col);
        });
      }
      function clearSearchResults() {
        searchResults.innerHTML = "";
        searchResultsWrap.classList.add("d-none");
      }
      function renderRoster(rows) {
        rosterTableBody.innerHTML = "";
        if (!rows.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = '<td colspan="6" class="text-secondary">尚無資料</td>';
          rosterTableBody.appendChild(tr);
          return;
        }
        rows.forEach((r, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td class="text-secondary">${i + 1}</td>
          <td>${escapeHtml(r.姓名 ?? "")}</td>
          <td>${escapeHtml(r.邀請人 ?? "")}</td>
          <td>${escapeHtml(r.繳費狀態 ?? "")}</td>
          <td>${escapeHtml(r.簽到 ?? "")}</td>
          <td>${escapeHtml(r.註記 ?? "")}</td>
        `;
          rosterTableBody.appendChild(tr);
        });
      }
      function updateCounters(total, paid) {
        countTotalEl.textContent = `報名 ${total}`;
        countPaidEl.textContent = `已繳 ${paid}`;
        courseCounters.classList.remove("d-none");
      }

      // ===== 產生可複製文字 =====
      function buildShareText(course, rows) {
        if (!course) return "";
        const dateStr = formatDate(course.date);
        const rawTitle = course.title || "";
        const courseName = rawTitle.replace(/^\d{8}/, "").trim() || rawTitle;

        const header = [`課程日期：${dateStr}`, `課程名稱：${courseName}`, `💰：現金/已繳費     Ⓛ：Linepay`, `🔖：長客券            ✅：完成報到`, `--------------`, `人員清單：`];

        const body = rows.map((r, i) => {
          const name = r.姓名 || "";
          const inviter = r.邀請人 || "";
          const payIcon = paymentIcon(r.繳費狀態);
          const checkIcon = checkinIcon(r.簽到);
          const inviterText = inviter ? `(${inviter})` : "";
          // 圖示直接緊接在姓名(邀請人)後面，若都沒有圖示則不留多餘空白
          return `${i + 1}.${name}${inviterText}${payIcon}${checkIcon}`;
        });

        return [...header, ...body].join("\n");
      }
      function fillShareText(course, rows) {
        shareTextEl.value = buildShareText(course, rows);
      }

      // ===== 主流程 =====
      async function selectCourse(course) {
        selectedCourse = course;
        courseTitle.textContent = `${course.title}｜${formatDate(course.date)}`;
        refreshBtn.disabled = true;
        rosterTableBody.innerHTML = '<tr><td colspan="6" class="text-secondary">載入中…</td></tr>';
        try {
          const values = await fetchSheetValuesByTitle(course.title);
          const rows = mapRowsToNeededColumns(values);
          renderRoster(rows);
          const total = rows.length;
          const paid = rows.filter((r) => isPaidValue(r["繳費狀態"])).length;
          updateCounters(total, paid);
          statusText.textContent = `共 ${total} 筆（已繳 ${paid}）`;
          location.hash = encodeURIComponent(course.title);
          fillShareText(course, rows);
        } catch (err) {
          console.error(err);
          statusText.textContent = "讀取失敗";
          renderRoster([]);
          fillShareText(null, []);
          showToast(err.message);
        } finally {
          refreshBtn.disabled = false;
        }
      }

      function mapRowsToNeededColumns(values) {
        if (!values || !values.values || !values.values.length) return [];
        const [header, ...data] = values.values;
        const norm = (s) =>
          (s || "")
            .toString()
            .replace(/[\s\u3000]/g, "")
            .toLowerCase();
        const idx = {};
        header.forEach((h, i) => (idx[norm(h)] = i));
        const need = ["姓名", "邀請人", "繳費狀態", "簽到", "註記"];
        const miss = need.filter((n) => !(norm(n) in idx));
        if (miss.length) {
          const alias = {
            繳費狀態: ["繳費", "付款狀態", "是否繳費"],
            簽到: ["是否簽到", "出席"],
            邀請人: ["推薦人", "介紹人"],
          };
          miss.forEach((n) => {
            (alias[n] || []).some((t) => norm(t) in idx && ((idx[norm(n)] = idx[norm(t)]), true));
          });
        }
        const rows = data.map((row) => ({
          姓名: row[idx[norm("姓名")]] || "",
          邀請人: row[idx[norm("邀請人")]] || "",
          繳費狀態: row[idx[norm("繳費狀態")]] || "",
          簽到: row[idx[norm("簽到")]] || "",
          註記: row[idx[norm("註記")]] || "",
        }));
        return rows.filter((r) => Object.values(r).some((v) => String(v).trim() !== ""));
      }

      function applySearch() {
        const q = searchInput.value.trim();
        if (!q) {
          showToast("請輸入關鍵字");
          return;
        }
        const isDateLike = /^\d{8}$/.test(q);
        const matched = courses.filter((c) => (isDateLike ? c.dateStr.includes(q) : c.title.toLowerCase().includes(q.toLowerCase())));
        if (!matched.length) {
          showToast("找不到符合的課程");
          clearSearchResults();
          return;
        }
        renderSearchResults(matched);
        statusText.textContent = `找到 ${matched.length} 堂課程`;
      }

      async function init() {
        if (!API_KEY || API_KEY.includes("YOUR_API_KEY")) {
          statusText.textContent = "尚未設定 API Key（請編輯原始碼）";
          showToast("請先在原始碼中設定 API_KEY");
        }
        if (location.protocol === "file:") {
          showToast("偵測到以檔案方式開啟；若 API Key 有「網站限制」可能會被擋，建議用本機伺服器或部署到網域。");
        }

        statusText.textContent = "載入課程中…";
        try {
          const data = await fetchSheetsList();
          const sheets = (data.sheets || []).map((s) => s.properties);
          courses = sheets
            .filter((s) => isCourseSheet(s.title))
            .map((s) => {
              const dateStr = extractDateStr(s.title);
              return { title: s.title, dateStr, date: yyyymmddToDate(dateStr), sheetId: s.sheetId };
            })
            .sort((a, b) => a.date - b.date);

          const today = new Date();
          futureCourses = courses.filter((c) => c.date >= new Date(today.getFullYear(), today.getMonth(), today.getDate()));

          renderAllCoursesDropdown(futureCourses);
          renderUpcomingFour(futureCourses);
          statusText.textContent = `共 ${courses.length} 個課程分頁（未來：${futureCourses.length}）`;

          // 預設載入：URL hash > 最近未來課 > 若無未來課則載入最近的一堂（過去）
          if (location.hash) {
            const t = decodeURIComponent(location.hash.slice(1));
            const hit = courses.find((c) => c.title === t);
            if (hit) selectCourse(hit);
            else if (futureCourses.length) selectCourse(futureCourses[0]);
            else if (courses.length) selectCourse(courses[courses.length - 1]);
          } else if (futureCourses.length) {
            selectCourse(futureCourses[0]);
          } else if (courses.length) {
            selectCourse(courses[courses.length - 1]);
          }
        } catch (err) {
          console.error(err);
          statusText.textContent = "載入課程失敗";
          showToast(err.message);
        }
      }

      // 事件
      searchBtn.addEventListener("click", applySearch);
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") applySearch();
      });
      refreshBtn.addEventListener("click", () => {
        if (selectedCourse) selectCourse(selectedCourse);
      });
      clearSearchBtn.addEventListener("click", clearSearchResults);
      copyBtn.addEventListener("click", async () => {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(shareTextEl.value);
          } else {
            // Fallback
            shareTextEl.select();
            document.execCommand("copy");
            shareTextEl.blur();
          }
          showToast("已複製到剪貼簿");
        } catch (e) {
          console.error(e);
          showToast("複製失敗，請手動全選複製");
        }
      });

      // 啟動
      document.addEventListener("DOMContentLoaded", init);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
